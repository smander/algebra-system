version: '3.8'

services:
  # Primary DynInst-enabled service
  dynint-dyninst:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/workspace
    working_dir: /workspace
    environment:
      - PYTHONPATH=/workspace
      - DYNINSTAPI_RT_LIB=/usr/local/lib/libdyninstAPI_RT.so
      - DYNINST_INSTALL=/usr/local
    command: /bin/bash
    stdin_open: true
    tty: true
    privileged: true
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
    security_opt:
      - seccomp:unconfined
      
  # Default dynint service (alias for DynInst)
  dynint:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/workspace
    working_dir: /workspace
    environment:
      - PYTHONPATH=/workspace
    command: /bin/bash
    stdin_open: true
    tty: true
    privileged: true
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
    security_opt:
      - seccomp:unconfined

  # Legacy services
  dynint-test:
    build: .
    volumes:
      - .:/app
    environment:
      - PYTHONPATH=/app/dynint
    working_dir: /app
    command: python -m pytest tests/ -v --tb=short
    
  dynint-shell:
    build: .
    volumes:
      - .:/app
    environment:
      - PYTHONPATH=/app/dynint
    working_dir: /app
    command: /bin/bash
    stdin_open: true
    tty: true
    
    
  dynint-map:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/workspace
    working_dir: /workspace
    environment:
      - PYTHONPATH=/workspace
    command: python -m dynint.cli map spacecraft_server_linux_x86 --output output/dynmap/spacecraft_map.json --bytes --with-dwarf
